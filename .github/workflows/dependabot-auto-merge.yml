name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@8348ea7f5d949b08c7f125a44b569c9626b05db3  # v1.7.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Check if auto-merge eligible
        id: check
        run: |
          # Only auto-merge patch updates (1.2.3 -> 1.2.4)
          # Never auto-merge minor (1.2.0 -> 1.3.0) or major (1.0.0 -> 2.0.0)
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          DEPENDENCY_NAMES="${{ steps.metadata.outputs.dependency-names }}"

          echo "Update type: $UPDATE_TYPE"
          echo "Dependencies: $DEPENDENCY_NAMES"

          # Check if it's a patch update
          if [ "$UPDATE_TYPE" = "version-update:semver-patch" ]; then
            echo "eligible=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Patch update - eligible for auto-merge"
          else
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è Not a patch update - requires manual review"
            echo "Update type: $UPDATE_TYPE"
          fi

          # Additional safety: Never auto-merge core dependencies
          CORE_DEPS="fastapi|uvicorn|neo4j|redis|openai|pydantic"
          if echo "$DEPENDENCY_NAMES" | grep -qE "$CORE_DEPS"; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è Core dependency - requires manual review"
          fi

      - name: Wait for CI checks
        if: steps.check.outputs.eligible == 'true'
        uses: lewagon/wait-on-check-action@e106e5c43e8ca1edea6383a39a01c5ca495fd812  # v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-regexp: '.*'  # Wait for all checks
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 30
          allowed-conclusions: success,skipped

      - name: Enable auto-merge
        if: steps.check.outputs.eligible == 'true'
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
          echo "‚úÖ Auto-merge enabled for PR #${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.check.outputs.eligible == 'true'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ü§ñ **Auto-merge enabled**

              This patch update will be automatically merged after all CI checks pass.

              **Update Details**:
              - Type: \`${{ steps.metadata.outputs.update-type }}\`
              - Dependencies: \`${{ steps.metadata.outputs.dependency-names }}\`
              - CVE fixes: ${{ steps.metadata.outputs.cvss > 0 && 'Yes ‚ö†Ô∏è' || 'No' }}

              **Safety Checks**:
              - ‚úÖ Patch-level update only
              - ‚úÖ Not a core dependency
              - ‚è≥ Waiting for CI checks to pass

              If you want to review manually, disable auto-merge with:
              \`\`\`bash
              gh pr merge --disable-auto ${{ github.event.pull_request.number }}
              \`\`\`
              `
            })

      - name: Comment why not auto-merged
        if: steps.check.outputs.eligible != 'true' && github.actor == 'dependabot[bot]'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚è∏Ô∏è **Manual review required**

              This PR was not auto-merged because:
              - Update type: \`${{ steps.metadata.outputs.update-type }}\`
              - Update types eligible for auto-merge: \`version-update:semver-patch\`

              **Auto-Merge Policy**:
              - ‚úÖ Patch updates (1.2.3 ‚Üí 1.2.4): Auto-merged if CI passes
              - ‚è∏Ô∏è Minor updates (1.2.0 ‚Üí 1.3.0): Manual review required
              - ‚è∏Ô∏è Major updates (1.0.0 ‚Üí 2.0.0): Manual review required
              - ‚è∏Ô∏è Core dependencies: Always manual review

              Please review and merge manually if appropriate.
              `
            })
