name: Sentinel Comprehensive Tests (CI/CD)

# PR #397: This workflow runs CI/CD-only sentinel checks that are disabled at runtime
# These checks validate static behavior that only changes on deployment:
# - S3: Paraphrase robustness (semantic search quality)
# - S4: Metrics wiring (observability infrastructure)
# - S7: Config parity (environment configuration)
# - S8: Capacity smoke (performance baselines)
# - S9: Graph intent (schema relationships)

on:
  pull_request:
    paths:
      - 'src/monitoring/sentinel/**'
      - 'src/mcp_server/**'
      - 'src/storage/**'
      - 'tests/monitoring/**'
  push:
    branches:
      - main
      - develop
  workflow_dispatch:  # Allow manual triggering

jobs:
  s3-full-paraphrase-matrix:
    name: S3 Paraphrase Robustness (Comprehensive Tests)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      neo4j:
        image: neo4j:5.13
        env:
          NEO4J_AUTH: neo4j/test_password_12345
          NEO4J_PLUGINS: '["apoc"]'
        ports:
          - 7687:7687
          - 7474:7474
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test_password_12345 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      qdrant:
        image: qdrant/qdrant:v1.7.0
        ports:
          - 6333:6333
        # Note: Qdrant doesn't have curl/wget, so we skip health check
        # The service will be ready when the port is available

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Start MCP server in background
        env:
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password_12345
          QDRANT_URL: http://localhost:6333
          REDIS_URL: redis://localhost:6379
          ENVIRONMENT: test
          ADMIN_API_KEY: test_admin_key_for_ci
          SENTINEL_API_KEY: test_sentinel_key_for_ci
        run: |
          python -m src.mcp_server.main &
          echo $! > mcp_server.pid
          sleep 10  # Wait for server to start

      - name: Run S3 Unit Tests (Code Logic Validation)
        env:
          TARGET_BASE_URL: http://localhost:8000
          SENTINEL_API_KEY: test_sentinel_key_for_ci
        run: |
          pytest tests/monitoring/test_paraphrase_robustness.py \
            --cov=src/monitoring/sentinel/checks/s3_paraphrase_robustness \
            --cov-report=xml \
            --cov-report=term \
            -v

      # PR #402: Run ACTUAL integration tests against live services
      # The unit tests above use mocks - these tests hit the real MCP server
      # PR #403: SENTINEL_API_KEY enables multi-backend cleanup (Neo4j + Qdrant)
      - name: Run Sentinel Integration Tests (Live Services)
        env:
          TARGET_BASE_URL: http://localhost:8000
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USER: neo4j
          NEO4J_PASSWORD: test_password_12345
          QDRANT_URL: http://localhost:6333
          REDIS_URL: redis://localhost:6379
          SENTINEL_API_KEY: test_sentinel_key_for_ci
        run: |
          echo "Running integration tests against live services..."
          echo "This validates that checks actually work, not just that code is correct."
          pytest tests/integration/test_sentinel_checks_live.py \
            -v \
            -m integration \
            --tb=short \
            --timeout=120

      - name: Upload S3 coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: s3-paraphrase-full
          name: s3-full-matrix

      - name: Stop MCP server
        if: always()
        run: |
          if [ -f mcp_server.pid ]; then
            kill $(cat mcp_server.pid) || true
          fi



  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [s3-full-paraphrase-matrix]
    if: always()

    steps:
      - name: Check all tests passed
        run: |
          echo "### Sentinel Comprehensive Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow validates sentinel checks with both **unit tests** (code logic) and **integration tests** (live services)." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Test Types (PR #402)" >> $GITHUB_STEP_SUMMARY
          echo "| Type | What it validates | Speed |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | Code logic with mocks | <1 second |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | Real services (Neo4j, Qdrant, Redis) | 10-30 seconds |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### CI/CD-Only Checks (validated on deploy)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Description | Unit | Integration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------------|------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| S1 | Health Probes | - | ✅ Live |" >> $GITHUB_STEP_SUMMARY
          echo "| S3 | Paraphrase Robustness | ✅ Mocked | ✅ Live |" >> $GITHUB_STEP_SUMMARY
          echo "| S4 | Metrics Wiring | ✅ Mocked | ✅ Live |" >> $GITHUB_STEP_SUMMARY
          echo "| S8 | Capacity Smoke | ✅ Mocked | ✅ Live |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Runtime Checks (continuous monitoring)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Frequency | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| S1 | 1 min | Health probes |" >> $GITHUB_STEP_SUMMARY
          echo "| S11 | 5 min | Firewall status |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Spot-Check Monitors (hourly validation)" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Frequency | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| S2 | 1 hour | Golden fact recall |" >> $GITHUB_STEP_SUMMARY
          echo "| S5 | 1 hour | Security negatives |" >> $GITHUB_STEP_SUMMARY
          echo "| S6 | 6 hours | Backup restore |" >> $GITHUB_STEP_SUMMARY
          echo "| S10 | 1 hour | Content pipeline |" >> $GITHUB_STEP_SUMMARY
