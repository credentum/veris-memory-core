# Context Store Infrastructure Services
# 
# IMPORTANT: Neo4j Password Synchronization
# This docker-compose file uses ${NEO4J_PASSWORD} environment variable.
# Make sure to set NEO4J_PASSWORD before starting:
# 
#   export NEO4J_PASSWORD=$(sudo cat /opt/context-store/credentials/neo4j_password)
#   docker-compose -f docker-compose.simple.yml up -d
#
# Or source the .env file that's created by setup-secure-credentials.sh

services:
  redis:
    image: redis:7.2.5-alpine@sha256:6aaf3f5e6bc8a592fbfe2cccf19eb36d27c39d12dab4f4b01556b7449e7b1f44
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - /raid1/docker-data/redis:/data
    # SECURITY: Redis with password authentication
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 8gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --protected-mode yes
    restart: unless-stopped

  neo4j:
    image: neo4j:5.15-community@sha256:69c579facb7acab1e98f28952b91144c89e469a081804a5dafebd6c3030433b8
    ports:
      - "127.0.0.1:7474:7474"
      - "127.0.0.1:7687:7687"
    volumes:
      - /raid1/docker-data/neo4j/data:/data
      - /raid1/docker-data/neo4j/logs:/logs
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-your_secure_neo4j_password_here}
      - NEO4J_server_memory_heap_initial__size=20G
      - NEO4J_server_memory_heap_max__size=20G
      - NEO4J_server_memory_pagecache_size=16G
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.15.1@sha256:d122138f76868edba68d36cb0833139c1d1761f00f09e48e61f8314196e6a4c6  # SECURITY: Updated to v1.15.1 to match other configs
    ports:
      - "127.0.0.1:6333:6333"
    volumes:
      - /raid1/docker-data/qdrant:/qdrant/storage
    restart: unless-stopped